# NyankoTube 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**NyankoTube** - YouTubeショート動画自動生成システム

### 1.2 目的
長尺動画（約60分）から、YouTubeショート向けの60秒縦型動画を簡単に作成できるWebアプリケーションを開発する。

### 1.3 主要技術
- **Next.js (App Router)**: フルスタックフレームワーク
- **Remotion**: 動画生成・編集ライブラリ
- **Prisma**: ORM（データベースアクセス）
- **PostgreSQL**: データベース
- **Tailwind CSS**: スタイリング
- **Google Cloud**: 本番環境インフラ

---

## 2. 機能要件

### 2.1 動画入力機能

| 項目 | 仕様 |
|------|------|
| 対応形式 | MP4, MOV |
| 元動画の長さ | 最大60分程度 |
| 入力方法 | ファイルアップロード |

### 2.2 動画切り出し機能

| 項目 | 仕様 |
|------|------|
| 切り出し方法 | 手動で開始・終了時間を指定 |
| 切り出し長さ | 最大55秒（オープニング5秒 + 本編55秒 = 60秒） |
| プレビュー | 切り出し範囲のプレビュー表示 |

### 2.3 アスペクト比変換（スマートクロップ）

| 項目 | 仕様 |
|------|------|
| 入力 | 16:9（横長） |
| 出力 | 9:16（縦長） |
| 変換方式 | **カーソル追跡クロップ**（優先）/ 中央固定クロップ |

#### カーソル追跡機能
PCの画面録画動画において、マウスカーソルの位置を自動検出し、常にカーソルが画面内に収まるようにクロップ位置を動的に調整する。

| 項目 | 仕様 |
|------|------|
| 検出方法 | 機械学習モデル or テンプレートマッチング |
| 追跡精度 | フレーム単位（30fps） |
| スムージング | 急激な移動を緩和（イージング処理） |
| フォールバック | カーソル未検出時は中央固定 |
| 手動調整 | カーソル追跡ON/OFF切り替え可能 |

```
┌─────────────────────────────────────────────────────────────┐
│                     元動画（16:9）                          │
│                                                             │
│     ┌─────────┐                                            │
│     │ 9:16    │    カーソル位置に                          │
│     │ クロップ │ ←─ 追従して移動                            │
│     │  範囲   │        🖱️                                  │
│     │         │                                            │
│     └─────────┘                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 オープニング挿入機能

| 項目 | 仕様 |
|------|------|
| オープニング動画 | ユーザーが事前に用意（アップロード） |
| 長さ | 約5秒 |
| 挿入位置 | 動画の冒頭に固定挿入 |

### 2.5 テロップ（字幕）機能

| 項目 | 仕様 |
|------|------|
| 生成方法 | 音声から自動文字起こし |
| フォント | ゴシック体 |
| スタイル | 視認性の高いデザイン（縁取り・影付き） |
| 位置 | 画面下部（セーフエリア内） |
| タイミング | 音声に自動同期 |
| 編集 | 生成後に手動編集可能 |

### 2.6 BGM・SE機能

| 項目 | 仕様 |
|------|------|
| BGM追加 | プリセットから選択 or カスタムアップロード |
| SE追加 | プリセットから選択 or カスタムアップロード |
| 音量調整 | 元動画の音声とのバランス調整可能 |

### 2.7 出力機能

| 項目 | 仕様 |
|------|------|
| 出力形式 | MP4 |
| 解像度 | 1080 x 1920（フルHD縦型） |
| 動画長 | 60秒 |
| フレームレート | 30fps |

---

## 3. 非機能要件

### 3.1 ユーザーインターフェース

- Webアプリケーションとして提供
- 直感的で使いやすいUI
- レスポンシブデザイン（デスクトップ優先）
- プレビュー機能付き

### 3.2 パフォーマンス

- 動画処理はバックグラウンドで実行
- 処理状況のプログレス表示
- 60分動画の処理: 目標5分以内

### 3.3 対応ブラウザ

- Google Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）

---

## 4. 画面構成

### 4.1 メイン画面（ダッシュボード）

```
┌─────────────────────────────────────────────────────────────┐
│  NyankoTube 🐱                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │          動画をドラッグ＆ドロップ                    │   │
│  │              または クリックして選択                 │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  オープニング動画: [ファイルを選択]                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 編集画面

```
┌─────────────────────────────────────────────────────────────┐
│  NyankoTube 🐱  > 編集                                      │
├───────────────────────────────┬─────────────────────────────┤
│                               │                             │
│   ┌───────────────────────┐   │   プレビュー               │
│   │                       │   │   ┌─────────────┐          │
│   │   タイムライン        │   │   │             │          │
│   │   (動画プレビュー)    │   │   │   9:16      │          │
│   │                       │   │   │   縦型      │          │
│   └───────────────────────┘   │   │   プレビュー │          │
│                               │   │             │          │
│   切り出し範囲               │   └─────────────┘          │
│   開始: [00:05:30]           │                             │
│   終了: [00:06:25]           │   テロップ編集              │
│                               │   ┌─────────────────────┐  │
│   BGM: [選択...]             │   │ 自動生成テキスト... │  │
│   SE:  [選択...]             │   └─────────────────────┘  │
│                               │                             │
├───────────────────────────────┴─────────────────────────────┤
│  [キャンセル]                              [動画を生成] 🎬  │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 エクスポート画面

```
┌─────────────────────────────────────────────────────────────┐
│  NyankoTube 🐱  > エクスポート                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                                                     │   │
│   │              動画を生成中...                        │   │
│   │                                                     │   │
│   │   ████████████████████░░░░░░░░░░  65%               │   │
│   │                                                     │   │
│   │   テロップ生成完了 ✓                                │   │
│   │   動画エンコード中...                               │   │
│   │                                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. システム構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Google Cloud Platform                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                     Next.js App (App Router)                      │  │
│  │                        (Cloud Run)                                │  │
│  ├───────────────────────────────────────────────────────────────────┤  │
│  │                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────┐    │  │
│  │   │                    Frontend Layer                        │    │  │
│  │   │              (React + Remotion + Tailwind)               │    │  │
│  │   ├─────────────────────────────────────────────────────────┤    │  │
│  │   │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │    │  │
│  │   │  │ 動画アップ  │  │  編集UI    │  │ プレビュー  │        │    │  │
│  │   │  │  ロード    │  │            │  │            │        │    │  │
│  │   │  └────────────┘  └────────────┘  └────────────┘        │    │  │
│  │   └─────────────────────────────────────────────────────────┘    │  │
│  │                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────┐    │  │
│  │   │                   Backend Layer                          │    │  │
│  │   │               (API Routes + Server Actions)              │    │  │
│  │   ├─────────────────────────────────────────────────────────┤    │  │
│  │   │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │    │  │
│  │   │  │ 音声認識   │  │ 動画処理   │  │  Remotion  │        │    │  │
│  │   │  │ (Whisper)  │  │ (FFmpeg)   │  │レンダリング │        │    │  │
│  │   │  └────────────┘  └────────────┘  └────────────┘        │    │  │
│  │   └─────────────────────────────────────────────────────────┘    │  │
│  │                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────┐    │  │
│  │   │                   Data Layer (Prisma)                    │    │  │
│  │   └─────────────────────────────────────────────────────────┘    │  │
│  │                              │                                    │  │
│  └──────────────────────────────┼────────────────────────────────────┘  │
│                                 │                                       │
│  ┌──────────────────────────────┼────────────────────────────────────┐  │
│  │                              ▼                                    │  │
│  │  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐  │  │
│  │  │   Cloud SQL    │    │ Cloud Storage  │    │  Cloud Tasks   │  │  │
│  │  │  (PostgreSQL)  │    │  (動画保存)    │    │ (非同期処理)   │  │  │
│  │  └────────────────┘    └────────────────┘    └────────────────┘  │  │
│  │                                                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 技術スタック

### 6.1 フレームワーク・言語
| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Next.js** | 14.x | フルスタックフレームワーク（App Router使用） |
| **React** | 18.x | UIライブラリ |
| **TypeScript** | 5.x | 型安全性 |
| **Node.js** | 20.x LTS | ランタイム |

### 6.2 スタイリング
| 技術 | 用途 |
|------|------|
| **Tailwind CSS** | ユーティリティファーストCSS |
| **shadcn/ui** | UIコンポーネントライブラリ（推奨） |

### 6.3 データベース・ORM
| 技術 | 用途 |
|------|------|
| **PostgreSQL** | リレーショナルデータベース |
| **Prisma** | ORM・データベースマイグレーション |

### 6.4 動画処理・画像解析
| 技術 | 用途 |
|------|------|
| **Remotion** | React ベースの動画生成 |
| **FFmpeg** | 動画エンコード・変換 |
| **Whisper API** (OpenAI) | 音声認識・文字起こし |
| **OpenCV.js** or **TensorFlow.js** | カーソル位置検出・追跡 |
| **sharp** | 画像処理（サムネイル生成等） |

### 6.5 インフラ（Google Cloud Platform）
| サービス | 用途 |
|----------|------|
| **Cloud Run** | Next.js アプリケーションホスティング |
| **Cloud SQL** | PostgreSQL マネージドサービス |
| **Cloud Storage** | 動画ファイル保存（元動画・生成動画） |
| **Cloud Tasks** | 動画処理の非同期ジョブ管理 |
| **Cloud Build** | CI/CD パイプライン |
| **Artifact Registry** | Docker イメージ管理 |

### 6.6 開発ツール
| ツール | 用途 |
|--------|------|
| **pnpm** | パッケージ管理 |
| **ESLint** | コード品質 |
| **Prettier** | コードフォーマット |
| **Docker** | コンテナ化 |
| **GitHub Actions** | CI/CD（Cloud Build連携） |

---

## 7. データベース設計

### 7.1 ER図（概要）

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   Project   │       │   Video     │       │  Subtitle   │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id          │──────<│ projectId   │──────<│ videoId     │
│ name        │       │ id          │       │ id          │
│ status      │       │ type        │       │ text        │
│ createdAt   │       │ filePath    │       │ startTime   │
│ updatedAt   │       │ duration    │       │ endTime     │
└─────────────┘       └─────────────┘       └─────────────┘
                             │
                             │
                      ┌──────┴──────┐
                      │  AudioTrack │
                      ├─────────────┤
                      │ videoId     │
                      │ id          │
                      │ type        │
                      │ filePath    │
                      │ volume      │
                      └─────────────┘
```

### 7.2 テーブル定義

#### Projects（プロジェクト）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | プライマリキー |
| name | VARCHAR(255) | プロジェクト名 |
| status | ENUM | 状態（draft, processing, completed, failed） |
| outputPath | VARCHAR(500) | 出力動画パス |
| createdAt | TIMESTAMP | 作成日時 |
| updatedAt | TIMESTAMP | 更新日時 |

#### Videos（動画）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | プライマリキー |
| projectId | UUID | 外部キー（Projects） |
| type | ENUM | 種別（source, opening, output） |
| filePath | VARCHAR(500) | Cloud Storage パス |
| duration | FLOAT | 動画長（秒） |
| startTime | FLOAT | 切り出し開始位置（秒） |
| endTime | FLOAT | 切り出し終了位置（秒） |
| cropX | INT | クロップX座標 |
| cropY | INT | クロップY座標 |

#### Subtitles（字幕）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | プライマリキー |
| videoId | UUID | 外部キー（Videos） |
| text | TEXT | 字幕テキスト |
| startTime | FLOAT | 表示開始時間（秒） |
| endTime | FLOAT | 表示終了時間（秒） |
| order | INT | 表示順序 |

#### AudioTracks（音声トラック）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | プライマリキー |
| videoId | UUID | 外部キー（Videos） |
| type | ENUM | 種別（bgm, se） |
| filePath | VARCHAR(500) | 音声ファイルパス |
| volume | FLOAT | 音量（0.0-1.0） |
| startTime | FLOAT | 再生開始時間（秒） |

#### CursorTracks（カーソル追跡データ）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | プライマリキー |
| videoId | UUID | 外部キー（Videos） |
| frameNumber | INT | フレーム番号 |
| cursorX | INT | カーソルX座標（元動画内） |
| cursorY | INT | カーソルY座標（元動画内） |
| cropX | INT | 計算されたクロップX座標 |
| cropY | INT | 計算されたクロップY座標 |
| confidence | FLOAT | 検出信頼度（0.0-1.0） |

※ カーソル追跡データは大量になるため、JSONファイルとしてCloud Storageに保存する方式も検討

---

## 8. API設計

### 8.1 エンドポイント一覧

| メソッド | パス | 説明 |
|----------|------|------|
| POST | `/api/projects` | プロジェクト作成 |
| GET | `/api/projects` | プロジェクト一覧取得 |
| GET | `/api/projects/[id]` | プロジェクト詳細取得 |
| DELETE | `/api/projects/[id]` | プロジェクト削除 |
| POST | `/api/upload` | 動画アップロード |
| POST | `/api/transcribe` | 音声文字起こし |
| POST | `/api/detect-cursor` | カーソル位置検出（全フレーム解析） |
| GET | `/api/cursor-track/[videoId]` | カーソル追跡データ取得 |
| PUT | `/api/subtitles/[id]` | 字幕編集 |
| POST | `/api/render` | 動画レンダリング開始 |
| GET | `/api/render/[id]/status` | レンダリング状況取得 |

### 8.2 Server Actions（Next.js）

```typescript
// 主要なServer Actions
'use server'

createProject(data: ProjectInput): Promise<Project>
uploadVideo(formData: FormData): Promise<Video>
transcribeAudio(videoId: string): Promise<Subtitle[]>
updateSubtitles(subtitles: SubtitleInput[]): Promise<void>
startRendering(projectId: string): Promise<RenderJob>
```

---

## 9. 開発フェーズ

### Phase 1: 基盤構築（1週目）
- [x] Next.js プロジェクトセットアップ（App Router）
- [x] Prisma + PostgreSQL セットアップ
- [x] Tailwind CSS + shadcn/ui 設定
- [x] 基本的なレイアウト・ナビゲーション
- [x] Cloud Storage 連携（アップロード機能）

### Phase 2: コア機能実装（2-3週目）
- [x] 動画アップロード・保存機能
- [x] Remotion セットアップ
- [x] 動画切り出し機能（タイムライン UI）
- [x] アスペクト比変換（16:9 → 9:16）
- [x] オープニング挿入機能
- [ ] プレビュー機能（Remotion Player統合済み、動画読み込み未実装）

### Phase 3: テロップ機能（4週目）
- [x] Whisper API 連携
- [x] テロップ自動生成
- [x] テロップスタイリング（ゴシック体・縁取り）
- [x] タイミング同期
- [x] テロップ手動編集 UI

### Phase 4: 追加機能（5週目）
- [ ] BGM/SE 追加機能
- [ ] 音量調整機能
- [ ] プリセット BGM/SE ライブラリ

### Phase 5: インフラ・デプロイ（6週目）
- [ ] Docker 化
- [ ] Cloud Run デプロイ設定
- [ ] Cloud SQL 接続設定
- [ ] Cloud Tasks 非同期処理
- [ ] CI/CD パイプライン構築

### Phase 6: 仕上げ（7週目）
- [ ] エクスポート機能の最適化
- [ ] UI/UX の改善
- [ ] テスト・バグ修正
- [ ] パフォーマンスチューニング

---

## 10. 成果物

1. **Webアプリケーション** - 動画生成システム本体（Cloud Run でホスティング）
2. **ソースコード** - GitHub リポジトリ
3. **データベース** - PostgreSQL スキーマ・マイグレーション
4. **インフラ構成** - Google Cloud リソース定義
5. **ドキュメント** - 使い方ガイド・API 仕様

---

## 11. 制約事項

### 技術的制約
- 動画処理はサーバーサイドで実行（Cloud Run のメモリ・CPU 制限に注意）
- 長尺動画（60分）の処理には数分かかる可能性あり
- 音声認識の精度は元動画の音質に依存
- Remotion のレンダリングには FFmpeg が必要

### インフラ制約
- Cloud Run のリクエストタイムアウト（最大60分）
- Cloud Storage のファイルサイズ上限（5TB）
- Cloud SQL の接続数制限
- Whisper API の利用コスト

### セキュリティ
- アップロード動画は一定期間後に自動削除
- ユーザー認証は将来的に実装予定（MVP では省略可）

---

## 12. 用語集

| 用語 | 説明 |
|------|------|
| Next.js | React ベースのフルスタックフレームワーク |
| App Router | Next.js 13+ の新しいルーティングシステム |
| Prisma | Node.js / TypeScript 向け ORM |
| Remotion | React ベースの動画生成フレームワーク |
| YouTubeショート | 60秒以下の縦型短尺動画フォーマット |
| テロップ | 動画上に表示される字幕テキスト |
| アスペクト比 | 動画の縦横比率 |
| Whisper | OpenAI の音声認識モデル |
| Cloud Run | Google Cloud のサーバーレスコンテナ実行環境 |
| Cloud SQL | Google Cloud のマネージド RDB サービス |
| Cloud Storage | Google Cloud のオブジェクトストレージ |
| Cloud Tasks | Google Cloud の非同期タスク実行サービス |

---

## 13. ディレクトリ構成（予定）

```
nyankotube/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (dashboard)/        # ダッシュボードグループ
│   │   │   ├── page.tsx        # トップページ
│   │   │   └── projects/
│   │   │       ├── page.tsx    # プロジェクト一覧
│   │   │       └── [id]/
│   │   │           ├── page.tsx      # プロジェクト詳細
│   │   │           └── edit/
│   │   │               └── page.tsx  # 編集画面
│   │   ├── api/                # API Routes
│   │   │   ├── projects/
│   │   │   ├── upload/
│   │   │   ├── transcribe/
│   │   │   └── render/
│   │   ├── layout.tsx
│   │   └── globals.css
│   ├── components/             # React コンポーネント
│   │   ├── ui/                 # shadcn/ui コンポーネント
│   │   ├── video/              # 動画関連コンポーネント
│   │   │   ├── VideoUploader.tsx
│   │   │   ├── VideoPlayer.tsx
│   │   │   ├── Timeline.tsx
│   │   │   └── Preview.tsx
│   │   ├── editor/             # 編集関連コンポーネント
│   │   │   ├── SubtitleEditor.tsx
│   │   │   └── AudioMixer.tsx
│   │   └── layout/             # レイアウトコンポーネント
│   ├── remotion/               # Remotion 動画テンプレート
│   │   ├── compositions/
│   │   │   └── ShortVideo.tsx
│   │   ├── components/
│   │   │   ├── Opening.tsx
│   │   │   ├── MainContent.tsx
│   │   │   └── Subtitle.tsx
│   │   └── Root.tsx
│   ├── lib/                    # ユーティリティ・設定
│   │   ├── prisma.ts           # Prisma クライアント
│   │   ├── storage.ts          # Cloud Storage ヘルパー
│   │   ├── whisper.ts          # Whisper API クライアント
│   │   └── ffmpeg.ts           # FFmpeg ヘルパー
│   ├── actions/                # Server Actions
│   │   ├── project.ts
│   │   ├── video.ts
│   │   └── render.ts
│   └── types/                  # 型定義
│       └── index.ts
├── prisma/
│   ├── schema.prisma           # Prisma スキーマ
│   └── migrations/             # マイグレーションファイル
├── public/
│   ├── fonts/                  # ゴシック体フォント
│   └── audio/                  # プリセット BGM/SE
├── docker/
│   └── Dockerfile
├── .env.example
├── .env.local
├── package.json
├── tailwind.config.ts
├── tsconfig.json
└── README.md
```

---

*最終更新: 2025年11月26日*

